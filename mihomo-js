/***
 * Clash Verge Rev å…¨å±€æ‰©å±•è„šæœ¬ï¼ˆæ‡’äººé…ç½®ï¼‰/ Mihomo Party è¦†å†™è„šæœ¬
 * URL: https://github.com/dahaha-365/YaNet/
 *
 * ä¿®å¤ï¼šTypeError: not a function é”™è¯¯ã€‚
 * è§£å†³å…¼å®¹æ€§é—®é¢˜ï¼šä½¿ç”¨ reduce æ›¿ä»£ .flat() ä»¥æé«˜åœ¨ Mihomo/Clash ç¯å¢ƒä¸­çš„å…¼å®¹æ€§ã€‚
 * é€»è¾‘ï¼šå®ç°ç­–ç•¥ç»„çš„ä¸‰å±‚åµŒå¥—ï¼šå…¨å±€è‡ªåŠ¨/æ‰‹åŠ¨å…¥å£ -> åœ°åŒºæ‰‹åŠ¨ç»„ -> åœ°åŒºè‡ªåŠ¨ç»„ã€‚
 */

const enable = true

const ruleOptions = {
    gfw: true, // è¢«å¢™ç½‘ç«™
    apple: true, // è‹¹æœæœåŠ¡
    microsoft: true, // å¾®è½¯æœåŠ¡
    github: true, // GithubæœåŠ¡
    google: true, // GoogleæœåŠ¡
    openai: true, // å›½å¤–AIå’ŒGPT
    spotify: false, // Spotify
    youtube: true, // YouTube
    bahamut: false, // å·´å“ˆå§†ç‰¹/åŠ¨ç”»ç–¯
    netflix: false, // Netflixç½‘é£
    tiktok: false, // å›½é™…ç‰ˆæŠ–éŸ³
    disney: false, // è¿ªå£«å°¼
    pixiv: false, // Pixiv
    hbo: false, // HBO
    biliintl: false, // å“”å“©å“”å“©ä¸œå—äºš
    tvb: false, // TVB
    hulu: false, // Hulu
    primevideo: false, // äºšé©¬é€Šprime video
    telegram: true, // Telegramé€šè®¯è½¯ä»¶
    line: false, // Lineé€šè®¯è½¯ä»¶
    whatsapp: false, // Whatsapp
    games: true, // æ¸¸æˆç­–ç•¥ç»„
    tracker: true, // ç½‘ç»œåˆ†æå’Œè·Ÿè¸ªæœåŠ¡
    ads: true, // å¸¸è§çš„ç½‘ç»œå¹¿å‘Š
}

const rules = [
    'RULE-SET,applications,ä¸‹è½½è½¯ä»¶',
    'PROCESS-NAME,SunloginClient,DIRECT',
    'PROCESS-NAME,SunloginClient.exe,DIRECT',
    'PROCESS-NAME,AnyDesk,DIRECT',
    'PROCESS-NAME,AnyDesk.exe,DIRECT',
]

const regionOptions = {
    excludeHighPercentage: true,
    regions: [
        {
            name: 'HKé¦™æ¸¯',
            regex: /æ¸¯|ğŸ‡­ğŸ‡°|hk|HK|hongkong|hong kong/i,
            ratioLimit: 2,
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Hong_Kong.png',
        },
        {
            name: 'USç¾å›½',
            regex: /ç¾|ğŸ‡ºğŸ‡¸|us|united state|america/i,
            ratioLimit: 2,
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/United_States.png',
        },
        {
            name: 'KRéŸ©å›½',
            regex: /éŸ©|ğŸ‡°ğŸ‡·|kr|korea/i,
            ratioLimit: 2,
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Korea.png',
        },
        {
            name: 'SGæ–°åŠ å¡',
            regex: /æ–°åŠ å¡|ğŸ‡¸ğŸ‡¬|sg|singapore/i,
            ratioLimit: 2,
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Singapore.png',
        },
        {
            name: 'TWå°æ¹¾çœ',
            regex: /å°æ¹¾|ğŸ‡¹ğŸ‡¼|tw|taiwan|tai wan/i,
            ratioLimit: 2,
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/China.png',
        },
        {
            name: 'GBè‹±å›½',
            regex: /è‹±|ğŸ‡¬ğŸ‡§|uk|united kingdom|great britain/i,
            ratioLimit: 2,
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/United_Kingdom.png',
        },
        {
            name: 'DEå¾·å›½',
            regex: /å¾·å›½|ğŸ‡©ğŸ‡ª|de|germany/i,
            ratioLimit: 2,
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Germany.png',
        },
        {
            name: 'MYé©¬æ¥è¥¿äºš',
            regex: /é©¬æ¥|ğŸ‡©ğŸ‡ª|my|malaysia/i,
            ratioLimit: 2,
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Malaysia.png',
        },
        {
            name: 'TKåœŸè€³å…¶',
            regex: /åœŸè€³å…¶|ğŸ‡¹ğŸ‡·|tk|turkey/i,
            ratioLimit: 2,
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Turkey.png',
        },
    ],
}
// è§„åˆ™é›†é€šç”¨é…ç½®
const ruleProviderCommon = {
    type: 'http',
    format: 'yaml',
    interval: 86400,
}
// ä»£ç†ç»„é€šç”¨é…ç½®
const groupBaseOption = {
    interval: 300,
    timeout: 3000,
    url: 'http://cp.cloudflare.com/generate_204',
    lazy: true,
    'max-failed-times': 3,
    hidden: false,
}

const ruleProviders = new Map()
ruleProviders.set('applications', {
    ...ruleProviderCommon,
    behavior: 'classical',
    format: 'text',
    url: 'https://github.com/DustinWin/ruleset_geodata/releases/download/mihomo-ruleset/applications.list',
    path: './ruleset/DustinWin/applications.list',
})

// ç¨‹åºå…¥å£
function main(config) {
    const proxyCount = config?.proxies?.length ?? 0
    const proxyProviderCount = typeof config?.['proxy-providers'] === 'object' ? Object.keys(config['proxy-providers']).length : 0
    if (proxyCount === 0 && proxyProviderCount === 0) {
        throw new Error('é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ä»»ä½•ä»£ç†')
    }

    // --- åŸºç¡€é…ç½®å’Œ DNS (ä¿æŒä¸å˜) ---
    config['allow-lan'] = true
    config['bind-address'] = '*'
    config['mode'] = 'rule'
    config['proxy-groups'] = config['proxy-groups'] || []
    
    // DNS é…ç½®
    const chinaDNS = ['119.29.29.29', '223.5.5.5']
    const foreignDNS = ['https://120.53.53.53/dns-query', 'https://223.5.5.5/dns-query']
    const userDefinedPolicy = config.dns?.['nameserver-policy'] || {}
    const scriptDefaultPolicy = {
        'geosite:private': 'system',
        'geosite:cn,steam@cn,category-games@cn,microsoft@cn,apple@cn': chinaDNS,
    }
    const finalPolicy = { ...userDefinedPolicy, ...scriptDefaultPolicy }

    const dnsConfig = {
        enable: true,
        listen: ':1053',
        ipv6: true,
        'prefer-h3': true,
        'use-hosts': true,
        'use-system-hosts': true,
        'respect-rules': true,
        'enhanced-mode': 'fake-ip',
        'fake-ip-range': '198.18.0.1/16',
        'fake-ip-filter': ['*', '+.lan', '+.local', '+.market.xiaomi.com'],
        nameserver: [...foreignDNS],
        'proxy-server-nameserver': [...foreignDNS],
        'nameserver-policy': finalPolicy
    }
    config['dns'] = dnsConfig

    // å…¶ä»–æ‚é¡¹é…ç½® (ä¿æŒä¸å˜)
    config['profile'] = { 'store-selected': true, 'store-fake-ip': true }
    config['unified-delay'] = true
    config['tcp-concurrent'] = true
    config['keep-alive-interval'] = 1800
    config['find-process-mode'] = 'strict'
    config['geodata-mode'] = true
    config['geodata-loader'] = 'memconservative'
    config['geo-auto-update'] = true
    config['geo-update-interval'] = 24
    config['sniffer'] = {
        enable: true,
        'force-dns-mapping': true,
        'parse-pure-ip': false,
        'override-destination': true,
        sniff: {
            TLS: { ports: [443, 8443], },
            HTTP: { ports: [80, '8080-8880'], },
            QUIC: { ports: [443, 8443], },
        },
        'skip-src-address': [ '127.0.0.0/8', '192.168.0.0/16', '10.0.0.0/8', '172.16.0.0/12', ],
        'force-domain': [ '+.google.com', '+.googleapis.com', '+.googleusercontent.com', '+.youtube.com', '+.facebook.com', '+.messenger.com', '+.fbcdn.net', 'fbcdn-a.akamaihd.net', ],
        'skip-domain': ['Mijia Cloud', '+.oray.com'],
    }
    config['ntp'] = { enable: true, 'write-to-system': false, server: 'cn.ntp.org.cn', }
    config['geox-url'] = {
        geoip: 'https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat',
        geosite: 'https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat',
        mmdb: 'https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb',
        asn: 'https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/GeoLite2-ASN.mmdb',
    }

    // --- ç­–ç•¥ç»„ç”Ÿæˆæ ¸å¿ƒé€»è¾‘é‡æ„ ---

    if (!enable) {
        return config
    }
    
    const allProxyNames = config.proxies.map((p) => p.name)
    const regionGroups = {} // { 'HKé¦™æ¸¯': ['Node1', 'Node2', ...], ... }
    let unclassifiedProxies = []
    const allProxyGroups = []

    // 1. åˆ’åˆ†ä»£ç†èŠ‚ç‚¹åˆ°å„è‡ªçš„åœ°åŒºåˆ†ç»„ï¼Œå¹¶è¿‡æ»¤å€ç‡ä¸ç¬¦çš„èŠ‚ç‚¹
    allProxyNames.forEach((proxyName) => {
        let matched = false
        // æå–å€ç‡ (åŸè„šæœ¬é€»è¾‘)
        const multiplier = /(?<=[xXâœ•âœ–â¨‰å€ç‡])([1-9]+(\.\d+)*|0{1}\.\d+)(?=[xXâœ•âœ–â¨‰å€ç‡])*/i.exec(proxyName)?.[1]
        const isRatioValid = parseFloat(multiplier || '0') <= 2; // ä½¿ç”¨é»˜è®¤çš„ ratioLimit=2 è¿›è¡Œåˆå§‹åˆ¤æ–­

        for (const region of regionOptions.regions) {
            const regex = new RegExp(region.regex)
            if (regex.test(proxyName)) {
                if (isRatioValid && parseFloat(multiplier || '0') <= region.ratioLimit) {
                    if (!regionGroups[region.name]) {
                        regionGroups[region.name] = []
                    }
                    regionGroups[region.name].push(proxyName)
                } 
                matched = true
                break
            }
        }
        if (!matched) {
            unclassifiedProxies.push(proxyName)
        }
    })

    // 2. ä¿®å¤ TypeError: not a function é”™è¯¯ï¼ˆä½¿ç”¨ reduce æ›¿ä»£ flatï¼‰
    // ç›®æ ‡ï¼šå°† { 'HK': [n1, n2], 'US': [n3] } è½¬æ¢ä¸º [n1, n2, n3]
    const classifiedProxyNames = Object.values(regionGroups).reduce((acc, val) => acc.concat(val), []);
    
    // è¿‡æ»¤æ‰é‚£äº›å·²ç»è¢«å½’ç±»åˆ°åœ°åŒºç»„çš„èŠ‚ç‚¹ï¼Œå‰©ä¸‹çš„æ‰æ˜¯çœŸæ­£çš„â€œæœªå½’ç±»â€èŠ‚ç‚¹
    unclassifiedProxies = unclassifiedProxies.filter((x) => !classifiedProxyNames.includes(x))
    
    
    // 3. å®šä¹‰å…¨å±€ç­–ç•¥ç»„æ‰€éœ€çš„æˆå‘˜åˆ—è¡¨
    const allRegionManualGroupNames = [] // åœ°åŒºä¸€çº§ç»„ (select) åç§°
    const allRegionAutoGroupNames = [] // åœ°åŒºäºŒçº§ç»„ (url-test) åç§°
    
    // 4. ä¸ºæ¯ä¸ªåœ°åŒºåˆ†ç»„ç”Ÿæˆâ€œè‡ªåŠ¨è´Ÿè½½å‡è¡¡ç»„â€(äºŒçº§) å’Œâ€œæ‰‹åŠ¨é€‰æ‹©ç»„â€(ä¸€çº§)
    for (const [regionName, proxies] of Object.entries(regionGroups)) {
        if (proxies.length === 0) continue

        // A. åœ°åŒºäºŒçº§ç»„ - è‡ªåŠ¨è´Ÿè½½å‡è¡¡ (url-test)
        const autoGroupName = `${regionName} (è‡ªåŠ¨)`
        const autoGroup = {
            name: autoGroupName,
            type: 'url-test',
            proxies: proxies,
            ...groupBaseOption,
        }
        allProxyGroups.push(autoGroup)
        allRegionAutoGroupNames.push(autoGroupName)

        // B. åœ°åŒºä¸€çº§ç»„ - æ‰‹åŠ¨é€‰æ‹© (select)
        const finalRegionGroup = {
            name: regionName,
            type: 'select',
            proxies: [
                autoGroupName, // è‡ªåŠ¨è´Ÿè½½å‡è¡¡/æ•…éšœåˆ‡æ¢é€‰é¡¹
                ...proxies, // æ‰‹åŠ¨é€‰æ‹©å•ä¸ªèŠ‚ç‚¹
            ],
            icon: regionOptions.regions.find(r => r.name === regionName)?.icon || groupBaseOption.icon,
        }
        allProxyGroups.push(finalRegionGroup)
        allRegionManualGroupNames.push(regionName)
    }

    // 5. å¤„ç†æœªåˆ†ç»„çš„èŠ‚ç‚¹ ("å…¶ä»–èŠ‚ç‚¹")
    if (unclassifiedProxies.length > 0) {
        const otherGroupName = 'ğŸŒ å…¶ä»–èŠ‚ç‚¹'
        const otherAutoGroupName = `${otherGroupName} (è‡ªåŠ¨)`

        // A. å…¶ä»–èŠ‚ç‚¹ - è‡ªåŠ¨è´Ÿè½½å‡è¡¡ (url-test)
        const otherAutoGroup = {
            name: otherAutoGroupName,
            type: 'url-test',
            proxies: unclassifiedProxies,
            ...groupBaseOption,
        }
        allProxyGroups.push(otherAutoGroup)
        allRegionAutoGroupNames.push(otherAutoGroupName)

        // B. å…¶ä»–èŠ‚ç‚¹ - æ‰‹åŠ¨é€‰æ‹© (select)
        const otherGroup = {
            name: otherGroupName,
            type: 'select',
            proxies: [otherAutoGroupName, ...unclassifiedProxies],
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/World_Map.png',
        }
        allProxyGroups.push(otherGroup)
        allRegionManualGroupNames.push(otherGroupName)
    }

    // 6. å®šä¹‰é¡¶çº§ç­–ç•¥ç»„ (å…¥å£)

    // A. âœˆï¸ è‡ªåŠ¨é€‰æ‹© (ä¸€çº§ç»„ - url-test): å…¨å±€æœ€ä¼˜èŠ‚ç‚¹
    const autoSelectGroup = {
        name: 'âœˆï¸ è‡ªåŠ¨é€‰æ‹©',
        type: 'url-test',
        proxies: allRegionAutoGroupNames, // åŒ…å«æ‰€æœ‰åœ°åŒºè‡ªåŠ¨ç»„
        ...groupBaseOption,
        icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Speedometer.png',
    }
    allProxyGroups.push(autoSelectGroup)

    // B. ğŸŒ æ‰‹åŠ¨é€‰æ‹© (ä¸€çº§ç»„ - select): å…¨å±€åœ°åŒºåˆ†ç±»é€‰æ‹©
    const manualSelectGroup = {
        name: 'ğŸŒ æ‰‹åŠ¨é€‰æ‹©',
        type: 'select',
        proxies: allRegionManualGroupNames, // åŒ…å«æ‰€æœ‰åœ°åŒºæ‰‹åŠ¨ç»„
        icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/World_Map.png',
    }
    allProxyGroups.push(manualSelectGroup)

    // C. ğŸš€ é€‰æ‹©èŠ‚ç‚¹ (æ ¸å¿ƒç­–ç•¥ç»„ - select): ä¾›åˆ†æµè§„åˆ™è°ƒç”¨
    const proxySelectGroup = {
        name: 'ğŸš€ é€‰æ‹©èŠ‚ç‚¹',
        type: 'select',
        proxies: [
            'âœˆï¸ è‡ªåŠ¨é€‰æ‹©', // é»˜è®¤æ¨èä½¿ç”¨è‡ªåŠ¨é€‰æ‹©
            'ğŸŒ æ‰‹åŠ¨é€‰æ‹©',
            'ç›´è¿', // ç›´è¿é€‰é¡¹
        ],
        icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Proxy.png',
    }
    allProxyGroups.push(proxySelectGroup)
    
    // D. ç»ˆæå‡ºå£ç­–ç•¥ç»„ (GLOBAL)
    const globalGroup = {
        name: 'GLOBAL',
        type: 'select',
        proxies: ['ğŸš€ é€‰æ‹©èŠ‚ç‚¹', 'ç›´è¿'],
        icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Flag.png',
    }
    allProxyGroups.push(globalGroup)

    // 7. å¤„ç†ç›´è¿èŠ‚ç‚¹ (ä¿æŒåŸé€»è¾‘)
    config.proxies = config?.proxies || []
    config.proxies.push({ name: 'ç›´è¿', type: 'direct', udp: true })
    
    // 8. é‡æ–°ç”Ÿæˆåˆ†æµç­–ç•¥ç»„ï¼Œç»Ÿä¸€æŒ‡å‘ 'ğŸš€ é€‰æ‹©èŠ‚ç‚¹'
    const proxyTarget = 'ğŸš€ é€‰æ‹©èŠ‚ç‚¹'
    const directTarget = 'ç›´è¿' 
    const domesticTarget = 'å›½å†…ç½‘ç«™'
    
    // è¦†ç›–åŸé…ç½®ä¸­çš„ç­–ç•¥ç»„åˆ—è¡¨
    config['proxy-groups'] = allProxyGroups

    rules.push(
        'GEOSITE,private,DIRECT',
        'GEOIP,private,DIRECT,no-resolve',
    )
    
    // å›½å†…ç½‘ç«™ç­–ç•¥ç»„
    config['proxy-groups'].push(
        { 
            ...groupBaseOption, 
            name: domesticTarget, 
            type: 'select', 
            proxies: [directTarget, proxyTarget], 
            url: 'http://wifi.vivo.com.cn/generate_204', 
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/StreamingCN.png', 
        }
    )

    // ä¸‹è½½è½¯ä»¶ç­–ç•¥ç»„ (é€»è¾‘ä¸å˜)
    config['proxy-groups'].push(
        { 
            ...groupBaseOption, 
            name: 'ä¸‹è½½è½¯ä»¶', 
            type: 'select', 
            proxies: [directTarget, 'REJECT', proxyTarget, domesticTarget], 
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Download.png',
        }
    )

    // è§„åˆ™é›†ç­–ç•¥ç»„ (ç»Ÿä¸€æŒ‡å‘ proxyTarget)
    if (ruleOptions.tracker) {
        rules.push('GEOSITE,tracker,è·Ÿè¸ªåˆ†æ')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'è·Ÿè¸ªåˆ†æ', type: 'select', proxies: ['REJECT', directTarget, proxyTarget], icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Reject.png', })
    }
    if (ruleOptions.ads) {
        rules.push('GEOSITE,category-ads-all,å¹¿å‘Šè¿‡æ»¤')
        rules.push('RULE-SET,adblockmihomo,å¹¿å‘Šè¿‡æ»¤')
        ruleProviders.set('adblockmihomo', { ...ruleProviderCommon, behavior: 'domain', format: 'mrs', url: 'https://github.com/217heidai/adblockfilters/raw/refs/heads/main/rules/adblockmihomo.mrs', path: './ruleset/adblockfilters/adblockmihomo.mrs', })
        config['proxy-groups'].push({ ...groupBaseOption, name: 'å¹¿å‘Šè¿‡æ»¤', type: 'select', proxies: ['REJECT', directTarget, proxyTarget], icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Advertising.png', })
    }
    if (ruleOptions.openai) {
        rules.push('DOMAIN-SUFFIX,grazie.ai,å›½å¤–AI', 'DOMAIN-SUFFIX,grazie.aws.intellij.net,å›½å¤–AI', 'RULE-SET,ai,å›½å¤–AI',)
        ruleProviders.set('ai', { ...ruleProviderCommon, behavior: 'classical', format: 'text', url: 'https://github.com/dahaha-365/YaNet/raw/refs/heads/dist/rulesets/mihomo/ai.list', path: './ruleset/YaNet/ai.list', })
        config['proxy-groups'].push({ ...groupBaseOption, name: 'å›½å¤–AI', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://chat.openai.com/cdn-cgi/trace', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/ChatGPT.png', })
    }
    if (ruleOptions.apple) {
        rules.push('GEOSITE,apple-cn,è‹¹æœæœåŠ¡')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'è‹¹æœæœåŠ¡', type: 'select', proxies: [proxyTarget, directTarget], url: 'http://www.apple.com/library/test/success.html', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Apple_2.png', })
    }
    if (ruleOptions.youtube) {
        rules.push('GEOSITE,youtube,YouTube')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'YouTube', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://www.youtube.com/s/desktop/494dd881/img/favicon.ico', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/YouTube.png', })
    }
    if (ruleOptions.biliintl) {
        rules.push('GEOSITE,biliintl,å“”å“©å“”å“©ä¸œå—äºš')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'å“”å“©å“”å“©ä¸œå—äºš', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://www.bilibili.tv/', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/bilibili_3.png', })
    }
    if (ruleOptions.bahamut) {
        rules.push('GEOSITE,bahamut,å·´å“ˆå§†ç‰¹')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'å·´å“ˆå§†ç‰¹', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://ani.gamer.com.tw/ajax/getdeviceid.php', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Bahamut.png', })
    }
    if (ruleOptions.disney) {
        rules.push('GEOSITE,disney,Disney+')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'Disney+', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://disney.api.edge.bamgrid.com/devices', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Disney+.png', })
    }
    if (ruleOptions.netflix) {
        rules.push('GEOSITE,netflix,NETFLIX')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'NETFLIX', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://api.fast.com/netflix/speedtest/v2?https=true', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Netflix.png', })
    }
    if (ruleOptions.tiktok) {
        rules.push('GEOSITE,tiktok,Tiktok')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'Tiktok', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://www.tiktok.com/', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/TikTok.png', })
    }
    if (ruleOptions.spotify) {
        rules.push('GEOSITE,spotify,Spotify')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'Spotify', type: 'select', proxies: [proxyTarget, directTarget], url: 'http://spclient.wg.spotify.com/signup/public/v1/account', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Spotify.png', })
    }
    if (ruleOptions.pixiv) {
        rules.push('GEOSITE,pixiv,Pixiv')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'Pixiv', type: 'select', proxies: [proxyTarget, directTarget], url: 'http://spclient.wg.spotify.com/signup/public/v1/account', icon: 'https://play-lh.googleusercontent.com/8pFuLOHF62ADcN0ISUAyEueA5G8IF49mX_6Az6pQNtokNVHxIVbS1L2NM62H-k02rLM=w240-h480-rw', })
    }
    if (ruleOptions.hbo) {
        rules.push('GEOSITE,hbo,HBO')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'HBO', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://www.hbo.com/favicon.ico', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/HBO.png', })
    }
    if (ruleOptions.tvb) {
        rules.push('GEOSITE,tvb,TVB')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'TVB', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://www.tvb.com/logo_b.svg', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/TVB.png', })
    }
    if (ruleOptions.primevideo) {
        rules.push('GEOSITE,primevideo,Prime Video')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'Prime Video', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://m.media-amazon.com/images/G/01/digital/video/web/logo-min-remaster.png', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Prime_Video.png', })
    }
    if (ruleOptions.hulu) {
        rules.push('GEOSITE,hulu,Hulu')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'Hulu', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://auth.hulu.com/v4/web/password/authenticate', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Hulu.png', })
    }
    if (ruleOptions.telegram) {
        rules.push('GEOIP,telegram,Telegram')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'Telegram', type: 'select', proxies: [proxyTarget, directTarget], url: 'http://www.telegram.org/img/website_icon.svg', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Telegram.png', })
    }
    if (ruleOptions.whatsapp) {
        rules.push('GEOSITE,whatsapp,WhatsApp')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'WhatsApp', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://web.whatsapp.com/data/manifest.json', icon: 'https://static.whatsapp.net/rsrc.php/v3/yP/r/rYZqPCBaG70.png', })
    }
    if (ruleOptions.line) {
        rules.push('GEOSITE,line,Line')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'Line', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://line.me/page-data/app-data.json', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Line.png', })
    }
    if (ruleOptions.games) {
        rules.push('GEOSITE,category-games@cn,å›½å†…ç½‘ç«™', 'GEOSITE,category-games,æ¸¸æˆä¸“ç”¨')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'æ¸¸æˆä¸“ç”¨', type: 'select', proxies: [proxyTarget, directTarget], icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Game.png', })
    }
    if (ruleOptions.google) {
        rules.push('GEOSITE,google,è°·æ­ŒæœåŠ¡')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'è°·æ­ŒæœåŠ¡', type: 'select', proxies: [proxyTarget, directTarget], url: 'http://www.google.com/generate_204', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Google_Search.png', })
    }
    if (ruleOptions.github) {
        rules.push('GEOSITE,github,Github')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'Github', type: 'select', proxies: [proxyTarget, directTarget], url: 'https://github.com/robots.txt', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/GitHub.png', })
    }
    if (ruleOptions.microsoft) {
        rules.push('GEOSITE,microsoft@cn,å›½å†…ç½‘ç«™', 'GEOSITE,microsoft,å¾®è½¯æœåŠ¡')
        config['proxy-groups'].push({ ...groupBaseOption, name: 'å¾®è½¯æœåŠ¡', type: 'select', proxies: [proxyTarget, directTarget], url: 'http://www.msftconnecttest.com/connecttest.txt', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Microsoft.png', })
    }
    if (ruleOptions.gfw) {
        rules.push('GEOSITE,gfw,å›½å¤–ç½‘ç«™');
        config['proxy-groups'].push({ ...groupBaseOption, name: 'å›½å¤–ç½‘ç«™', type: 'select', proxies: [proxyTarget, directTarget], url: 'http://www.google.com/generate_204', icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/World_Map.png', });
    }

    // 9. æœ€ç»ˆè§„åˆ™å’Œæ¼ç½‘ä¹‹é±¼
    rules.push(
        'GEOSITE,cn,å›½å†…ç½‘ç«™',
        'GEOIP,cn,å›½å†…ç½‘ç«™,no-resolve',
        'MATCH,æ¼ç½‘ä¹‹é±¼'
    )
    
    config['proxy-groups'].push(
        // æ¼ç½‘ä¹‹é±¼
        { 
            ...groupBaseOption, 
            name: 'æ¼ç½‘ä¹‹é±¼', 
            type: 'select', 
            proxies: [proxyTarget, domesticTarget], 
            icon: 'https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Streaming!CN.png', 
        }
    )

    // 10. è¦†ç›–åŸé…ç½®
    config['rules'] = rules
    config['rule-providers'] = Object.fromEntries(ruleProviders)

    // è¿”å›ä¿®æ”¹åçš„é…ç½®
    return config
}
